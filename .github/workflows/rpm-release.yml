on:
  push:
    tags:
      - v*


name: Create RPM Release
jobs:
      release:
        name: Release pushed tag
        runs-on: ubuntu-22.04
        steps:         
          - name: Create release
            id: create_release
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              ref: ${{ github.event.push.ref }}
            run: |
              tag=${ref##*/}
    
              gh release create "$tag" \
                  --repo="$GITHUB_REPOSITORY" \
                  --title="${GITHUB_REPOSITORY#*/} ${tag#v}" \
                  --generate-notes
      
          - name: build RPM package
            id: rpm_build
            uses: naveenrajm7/rpmbuild@master
            with: 
                spec_file: "./packaging/rpm/pamoauth2device.spec"

          - name: Upload Release Asset
            id: upload-release-asset 
            uses: actions/upload-release-asset@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`.  
                asset_path: ${{ steps.rpm_build.outputs.source_rpm_path }}
                asset_name: ${{ steps.rpm_build.outputs.source_rpm_name }}
                asset_content_type: ${{ steps.rpm_build.outputs.rpm_content_type }}
          
          
